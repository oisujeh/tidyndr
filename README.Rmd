---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "man/figures/README-",
  out.width = "100%"
)
```

# tidyndr

<!-- badges: start -->
<!-- badges: end -->

The goal of {tidyndr} is to provide specialized, simple and easy to use functions that wrap around existing functions in `R` for manipulation of the [NDR](http://ndr.shieldnigeriaproject.com) patient line-list file allowing the user to focus on the tasks to be completed rather than the details of the code.  

The functions presented are similar to the [PEPFAR MER indicators](https://datim.zendesk.com/hc/en-us/articles/360000084446-MER-Indicator-Reference-Guides) and are currently grouped into three categories:

* The `read_ndr` function for reading the patient-level line-list downloaded from the front-end of the NDR in 'csv' format. 

* The PEPFAR treatment group of indicators that can be performed on the NDR           line-list.

* The 'Viral Suppression' indicators (`tx_vl_eligible()`, `tx_pvls_den()` and `tx_pvls_num()`).

## Installation

<!-- You can install the released version of tidyndr from [CRAN](https://CRAN.R-project.org) with: -->

<!-- ``` r -->
<!-- install.packages("tidyndr") -->
<!-- ``` -->

This package is currently not available on [CRAN](https://CRAN.R-project.org) but you can install the development version from [GitHub](https://github.com/) with:

``` r
# install.packages("devtools")
devtools::install_github("stephenbalogun/tidyndr")
```
## Usage

```{r load_library}
library(tidyndr)
library(magrittr) ## to use the piping operator "%>%"
```

### read_ndr

`read_ndr()` reads the downloaded csv file into [`R`](https:://cran.r-project.org) using [`vroom::vroom()`](https://vroom.r-lib.org/) behind the scene and passing appropriate column types to the `col_types` argument. It also formats the variable names using the [`snakecase`](https://en.wikipedia.org/wiki/Snake_case) style. It can read from the local file or from a line-list placed on the internet.

```{r read_ndr}
## read from a local file path (not run)

# file_path <- system.file("extdata", "ndr_example.csv", package = "tidyndr")

# read_ndr(file_path)

### read line-list available on the internet
path <- "https://raw.githubusercontent.com/stephenbalogun/example_files/main/ndr_example.csv"

ndr_example <- read_ndr(path)
```

### Treatment Indicators

The functions included in this group are:

* `tx_new()`  

* `tx_curr()`  

* `tx_ml()` and `tx_ml_outcomes()`

* `tx_rtt()` 

* Other supporting functions are: `tx_mmd()`, `tx_regimen()` and `tx_appointment()`

```{r tx_indicators}
## Subset "TX_NEW"
tx_new(ndr_example)

## Subset "TX_CURR" for a state
ndr_example %>%
  tx_curr(states = "State 1")

## Generate line-list of clients with medication refill in January 2021 for a facility (Facility 1)
ndr_example %>%
  tx_appointment(from = "2021-01-01",
                 to = "2021-01-31",
                 facilities = "Facility 1")

## Generate list of clients who were active at the beginning of FY21 but became inactive at the end of Q1 of FY21.
ndr_example %>%
  tx_ml(from = "2020-10-01",
        to = "2020-12-31")
```


### Viral Suppression Indicators

The `tx_vl_eligible()`, `tx_pvls_den()` and the `tx_pvls_num()` functions come in handy when you need to generate the line-list of clients who are eligible for viral load test at a given point for a given facility/state, those who have a valid viral load result (not more than 1 year for people aged 20 years and above and not more than 6 months for paediatrics and adolescents less or equal to 19 years), and those who are virally suppressed (out of those with valid viral load results). When the `sample = TRUE` attribute is supplied to the `tx_vl_eligible()` function, it generates the line-list of only those who are due for a viral load test out of all those who are eligible.

```{r vl_indicators}
## Generate list of clients who are eligible for VL (i.e. expected to have a documented VL result)
ndr_example %>%
  tx_vl_eligible()

## Generate list of clients that will be expected to have a viral load test done in Q2 of FY21 for "State 2"
ndr_example %>%
  tx_vl_eligible("2021-03-31",
                 states = "State 2",
                 sample = TRUE)

### Calculate the Viral Load Coverage for State 3
no_of_vl_results <- tx_pvls_den(ndr_example, states = "State 3") %>%
  nrow()
no_of_vl_eligible <- tx_vl_eligible(ndr_example, states = "State 3") %>%
  nrow()

vl_coverage <- scales::percent(no_of_vl_results / no_of_vl_eligible)

print(vl_coverage)
  
```

For all the 'Treatment' and 'Viral Suppression' indicators (except `tx_ml_outcomes()`, which should be use with `tx_ml()`), you have control over the level of action (state or facility) by supplying to the `state` and/or `facility` arguments the values of interest . For more than one state or facility, combine the values with the `c()` e.g.

```{r multiple_indicators}
## subset clients that have medication appointment in Q2 of FY21 for "State 1" and "State 3" and are also due for viral load
ndr_example %>%
  tx_appointment(from = "2021-01-01",
                 to = "2021-03-31",
                 states = c("State 1", "State 3")) %>%
  tx_vl_eligible(sample = TRUE)
```

### Summarising your Indicators
=======

You might want to generate a summary table of all the indicators you have pulled out. The `summarise_ndr()` (or `summarize_ndr()`) allows you to do this with ease. It accepts all the line-lists you are interested in creating a summary table for, the level at which you want the summary to be created (country/ip, state or facility), and the names you want to give to each of your summary column.


```{r, summarise_ndr}
new <- tx_new(ndr_example)  ## generates line-list of TX_NEW for the FY
curr <- tx_curr(ndr_example) ## generates line-list of currently active clients
ml <- tx_ml(ndr_example) ## generates line-list of clients who were active at the beginning of the FY but currently inactive

summarise_ndr(data = list(new, curr, ml),
              level = "state",
              names = c("tx_new", "tx_curr", "tx_ml"))


```
